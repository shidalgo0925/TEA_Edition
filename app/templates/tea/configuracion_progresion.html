{% extends "tea/base.html" %}

{% block title %}Configuración de Progresión - TEA Edition{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line text-primary"></i> Configuración de Progresión</h2>
                <button class="btn btn-outline-secondary" onclick="history.back()">
                    <i class="fas fa-arrow-left"></i> Volver
                </button>
            </div>
        </div>
    </div>

    <!-- Información del Sistema -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle"></i> Sistema de Progresión Permanente</h5>
                <p class="mb-0">
                    Este sistema funciona como un videojuego: <strong>nunca retrocede, siempre avanza</strong>. 
                    Los niños pueden empezar en cualquier nivel según su edad y habilidades, pero una vez que 
                    comienzan a jugar, solo pueden avanzar hacia niveles superiores.
                </p>
            </div>
        </div>
    </div>

    <!-- Configuración de Nivel Inicial -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-cog"></i> Configurar Nivel Inicial</h5>
                </div>
                <div class="card-body">
                    <form id="configProgresionForm">
                        <div class="mb-3">
                            <label for="ninoSelect" class="form-label">Seleccionar Niño:</label>
                            <select class="form-select" id="ninoSelect" required>
                                <option value="">Selecciona un niño...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="nivelInicial" class="form-label">Nivel Inicial:</label>
                            <select class="form-select" id="nivelInicial" required>
                                <option value="inicial">Inicial (3-4 años)</option>
                                <option value="basico_1">Básico 1 (4-5 años)</option>
                                <option value="basico_2">Básico 2 (5-6 años)</option>
                                <option value="basico_3">Básico 3 (6-7 años)</option>
                                <option value="intermedio_1">Intermedio 1 (7-8 años)</option>
                                <option value="intermedio_2">Intermedio 2 (8-9 años)</option>
                                <option value="intermedio_3">Intermedio 3 (9-10 años)</option>
                                <option value="avanzado_1">Avanzado 1 (10-11 años)</option>
                                <option value="avanzado_2">Avanzado 2 (11-12 años)</option>
                                <option value="avanzado_3">Avanzado 3 (12+ años)</option>
                                <option value="experto">Experto (Todas las edades)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción del Nivel:</label>
                            <div id="descripcionNivel" class="alert alert-light">
                                Selecciona un nivel para ver su descripción
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="btnConfigurar">
                                <i class="fas fa-save"></i> Configurar Nivel Inicial
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Información del Niño Seleccionado -->
            <div class="card" id="infoNino" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-child"></i> Información del Niño</h5>
                </div>
                <div class="card-body">
                    <div id="detallesNino">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Guía de Niveles -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-book"></i> Guía de Niveles</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="guiaNiveles">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nivelInicial">
                                    Inicial
                                </button>
                            </h2>
                            <div id="nivelInicial" class="accordion-collapse collapse" data-bs-parent="#guiaNiveles">
                                <div class="accordion-body">
                                    <strong>Edad recomendada:</strong> 3-4 años<br>
                                    <strong>Habilidades:</strong> Reconocimiento básico, primeras palabras<br>
                                    <strong>Actividades:</strong> Colores básicos, números 1-2, sonidos simples
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nivelBasico">
                                    Básico (1-3)
                                </button>
                            </h2>
                            <div id="nivelBasico" class="accordion-collapse collapse" data-bs-parent="#guiaNiveles">
                                <div class="accordion-body">
                                    <strong>Edad recomendada:</strong> 4-7 años<br>
                                    <strong>Habilidades:</strong> Vocabulario básico, números simples<br>
                                    <strong>Actividades:</strong> Palabras familiares, números 1-10, colores
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nivelIntermedio">
                                    Intermedio (1-3)
                                </button>
                            </h2>
                            <div id="nivelIntermedio" class="accordion-collapse collapse" data-bs-parent="#guiaNiveles">
                                <div class="accordion-body">
                                    <strong>Edad recomendada:</strong> 7-10 años<br>
                                    <strong>Habilidades:</strong> Frases, operaciones básicas<br>
                                    <strong>Actividades:</strong> Frases de 2-3 palabras, sumas y restas
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nivelAvanzado">
                                    Avanzado (1-3)
                                </button>
                            </h2>
                            <div id="nivelAvanzado" class="accordion-collapse collapse" data-bs-parent="#guiaNiveles">
                                <div class="accordion-body">
                                    <strong>Edad recomendada:</strong> 10-12+ años<br>
                                    <strong>Habilidades:</strong> Conversaciones, problemas complejos<br>
                                    <strong>Actividades:</strong> Historias, problemas de palabras, números grandes
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas de Progresión -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-chart-bar"></i> Estadísticas de Progresión</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="estadisticasProgresion">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    cargarNinos();
    cargarEstadisticas();
    
    // Event listeners
    document.getElementById('ninoSelect').addEventListener('change', cargarInfoNino);
    document.getElementById('nivelInicial').addEventListener('change', actualizarDescripcionNivel);
    document.getElementById('configProgresionForm').addEventListener('submit', configurarNivel);
});

function cargarNinos() {
    fetch('/tea/padres/api/ninos')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('ninoSelect');
            select.innerHTML = '<option value="">Selecciona un niño...</option>';
            
            data.ninos.forEach(nino => {
                const option = document.createElement('option');
                option.value = nino.id;
                option.textContent = `${nino.nombre} (${nino.edad} años)`;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error:', error));
}

function cargarInfoNino() {
    const ninoId = document.getElementById('ninoSelect').value;
    if (!ninoId) {
        document.getElementById('infoNino').style.display = 'none';
        return;
    }
    
    fetch(`/tea/padres/api/nino/${ninoId}/progresion`)
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById('detallesNino');
            infoDiv.innerHTML = `
                <p><strong>Nombre:</strong> ${data.nombre}</p>
                <p><strong>Edad:</strong> ${data.edad} años</p>
                <p><strong>Nivel Actual:</strong> <span class="badge bg-primary">${data.nivel_actual}</span></p>
                <p><strong>Puntos Totales:</strong> ${data.puntos_totales}</p>
                <p><strong>Actividades Completadas:</strong> ${data.actividades_completadas}</p>
                <p><strong>Días Consecutivos:</strong> ${data.dias_consecutivos}</p>
                ${data.actividades_completadas === 0 ? 
                    '<div class="alert alert-success mt-2"><small>Este niño puede configurar su nivel inicial</small></div>' :
                    '<div class="alert alert-warning mt-2"><small>Este niño ya ha empezado a jugar. No se puede cambiar el nivel inicial.</small></div>'
                }
            `;
            document.getElementById('infoNino').style.display = 'block';
        })
        .catch(error => console.error('Error:', error));
}

function actualizarDescripcionNivel() {
    const nivel = document.getElementById('nivelInicial').value;
    const descripciones = {
        'inicial': 'Nivel para niños de 3-4 años. Actividades muy básicas de reconocimiento y primeras palabras.',
        'basico_1': 'Nivel básico 1 para niños de 4-5 años. Vocabulario familiar y números simples.',
        'basico_2': 'Nivel básico 2 para niños de 5-6 años. Palabras de casa y números del 1 al 5.',
        'basico_3': 'Nivel básico 3 para niños de 6-7 años. Palabras de comida y números con dedos.',
        'intermedio_1': 'Nivel intermedio 1 para niños de 7-8 años. Frases de 2 palabras y números del 1 al 10.',
        'intermedio_2': 'Nivel intermedio 2 para niños de 8-9 años. Frases de 3 palabras y sumas simples.',
        'intermedio_3': 'Nivel intermedio 3 para niños de 9-10 años. Preguntas simples y restas.',
        'avanzado_1': 'Nivel avanzado 1 para niños de 10-11 años. Historias cortas y números del 1 al 20.',
        'avanzado_2': 'Nivel avanzado 2 para niños de 11-12 años. Conversaciones y operaciones mixtas.',
        'avanzado_3': 'Nivel avanzado 3 para niños de 12+ años. Descripciones detalladas y problemas de palabras.',
        'experto': 'Nivel experto para todas las edades. Historias creativas y números del 1 al 100.'
    };
    
    document.getElementById('descripcionNivel').innerHTML = descripciones[nivel] || 'Selecciona un nivel para ver su descripción';
}

function configurarNivel(e) {
    e.preventDefault();
    
    const ninoId = document.getElementById('ninoSelect').value;
    const nivelInicial = document.getElementById('nivelInicial').value;
    
    if (!ninoId || !nivelInicial) {
        alert('Por favor selecciona un niño y un nivel inicial');
        return;
    }
    
    const btn = document.getElementById('btnConfigurar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Configurando...';
    
    fetch('/tea/padres/api/configurar-nivel-inicial', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            nino_id: ninoId,
            nivel_inicial: nivelInicial
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Nivel inicial configurado correctamente');
            cargarInfoNino();
            cargarEstadisticas();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al configurar el nivel inicial');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Configurar Nivel Inicial';
    });
}

function cargarEstadisticas() {
    fetch('/tea/padres/api/estadisticas-progresion')
        .then(response => response.json())
        .then(data => {
            const statsDiv = document.getElementById('estadisticasProgresion');
            statsDiv.innerHTML = `
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary">${data.total_ninos}</h4>
                        <p class="mb-0">Niños Registrados</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success">${data.ninos_activos}</h4>
                        <p class="mb-0">Niños Activos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning">${data.nivel_promedio}</h4>
                        <p class="mb-0">Nivel Promedio</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info">${data.actividades_totales}</h4>
                        <p class="mb-0">Actividades Completadas</p>
                    </div>
                </div>
            `;
        })
        .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}





