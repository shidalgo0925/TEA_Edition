# -*- coding: utf-8 -*-
# Compatibilidad ZoneInfo: Python 3.9+ / backport para 3.8
try:
    from zoneinfo import ZoneInfo  # Python 3.9+
except ImportError:
    from backports.zoneinfo import ZoneInfo  # Python 3.8

from datetime import datetime
from googleapiclient.discovery import build

# LOCAL_TZ desde config, con default seguro si no existe
try:
    from config import LOCAL_TZ  # e.g., "America/Panama"
except Exception:
    LOCAL_TZ = "America/Panama"

# Palabras clave por categoría (simple y efectivo)
KEYWORDS = {
    "Mariachi": ["mariachi", "ensayo", "evento", "misa", "sepelio", "funeral"],
    "Easytech": ["odoo", "import center", "flutter", "firebase", "backend", "flask", "app", "comuniapp"],
    "Personal": ["desayuno", "almuerzo", "cena", "descanso", "lectura", "diario", "familia", "ejercicio"],
}

def categorize(title: str, description: str = "") -> str:
    text = f"{title} {description}".lower()
    for cat, words in KEYWORDS.items():
        if any(w in text for w in words):
            return cat
    return "Personal"

def get_today_events(creds, max_results=50):
    service = build("calendar", "v3", credentials=creds)

    tz = ZoneInfo(LOCAL_TZ)
    now = datetime.now(tz)
    start = datetime(now.year, now.month, now.day, 0, 0, 0, tzinfo=tz).isoformat()
    end = datetime(now.year, now.month, now.day, 23, 59, 59, tzinfo=tz).isoformat()

    events_result = service.events().list(
        calendarId="primary",
        timeMin=start,
        timeMax=end,
        singleEvents=True,
        orderBy="startTime",
        maxResults=max_results
    ).execute()

    events = []
    for ev in events_result.get("items", []):
        title = ev.get("summary", "(Sin título)")
        desc = ev.get("description", "") or ""
        s_info = ev.get("start", {})
        e_info = ev.get("end", {})

        # start/end pueden ser 'dateTime' o 'date'
        s = s_info.get("dateTime") or (s_info.get("date") + "T00:00:00")
        e = e_info.get("dateTime") or (e_info.get("date") + "T23:59:59")

        sh = s[11:16]
        eh = e[11:16]
        cat = categorize(title, desc)

        events.append({
